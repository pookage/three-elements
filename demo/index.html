<!DOCTYPE html>
<html>
	<head>
		<title>THREE-Elements | Demo</title>

		<!-- create an import map to  make for neater imports -->
		<script type="importmap">
			{
				"imports": {
					"three"           : "https://unpkg.com/three@0.157.0/build/three.module.min.js",
					"three/addons/"   : "https://unpkg.com/three@0.157.0/examples/jsm/",
					"three-ecs"       : "../lib/three-ecs/index.js",
					"three-ecs/"      : "../lib/three-ecs/",
					"three-elements"  : "../index.js",
					"three-elements/" : "../"
				}
			}
		</script>

		<!-- import custom element defintions, which import the required three-ecs definitions -->
		<script type="module">
			import { ThreeEntity, attributeRegistry } from "three-elements";
			import { Entity, Component, System, Geometry, Material, Mesh } from "three-ecs";

			console.log(`
				TODO:
					2. refactor three-elements so that Entities are initialised with any components specified as attributes
					3. check if (2) removes the need for DOMContentLoaded
					4. rename 'Shader' to 'CustomShader' throughout three-elements and three-ecs
			`)

			// CUSTOM COMPONENTS
			// ---------------------------------------------
			class NoisyComponent extends Component {
				static get schema(){
					return {
						message: {
							default: "monkey"
						}
					}
				}// get schema

				added(entity){
					super.added(entity);

					entity.addEventListener("SYSTEM__NOISY_SYSTEM__UPDATE", this.#handleNoisySystemUpdate);

					console.log("Noisy component added!");
				}// added

				#handleNoisySystemUpdate = event => {
					console.log(`The noisy system told me to say: ${this.data.message}!`);
				}// #handleNoisySystemUpdate
			}// NoisyComponent

			attributeRegistry.set("noisy", NoisyComponent);


			// CUSTOM SYSTEMS
			// ---------------------------------------------
			class NoisySystem extends System {
				#interval;

				static get autoregister(){
					return [
						NoisyComponent
					]
				}// get autoregister

				constructor(){
					super();

					this.#interval = setInterval(this.update.bind(this), 1000);
				}// constructor

				added(entity){
					super.added(entity);

					console.log("Noisy system added!");
				}// added
				removed(entity){
					super.removed(entity);

					clearInterval(this.#interval);
				}// removed

				update(){
					for(const component of this.registeredComponentList.values()){
						component.entity.dispatchEvent({
							type: "SYSTEM__NOISY_SYSTEM__UPDATE"
						});
					}
				}// update
			}// NoisySystem

			attributeRegistry.set("noisy-system", NoisySystem);


			// CUSTOM ENTITIES
			// ---------------------------------------------
			class NoisyEntity extends Entity {
				static get defaultComponents(){
					return new Map([
						[ NoisyComponent, {
							"message": "ahoy"
						}]
					])
				}
				static get mappings(){
					return {
						...super.mappings,
						"message": [ NoisyComponent, "message" ]
					}
				}// get mappings
			}// NoisyEntity

			class Box extends Entity {
				static get defaultComponents(){
					return new Map([
						[ Geometry, {
							primitive: "box",
							height: 1,
							width:  1,
							depth:  1
						}],
						[ Material, {
							color: 0xff0000
						}],
						[ Mesh ]
					])
				}// get defaultComponents
				static get mappings(){
					return {
						...Entity.mappings,
						"color"        : [ Material, "color"  ],
						"materialType" : [ Material, "type"   ],
						"shader"       : [ Material, "shader" ]
					};
				}// get mappings
			}// Box


			// CUSTOM ELEMENTS
			// ---------------------------------------------
			class ThreeBoxElement extends ThreeEntity {
				static get mappings(){
					return {
						"monkey-color": "color",
						"material-type": "materialType"
					}
				}
				init(){
					return new Box();
				}// init
			}// ThreeBox

			class ThreeNoisyElement extends ThreeEntity {
				init(){
					return new NoisyEntity();
				}// init
			}// ThreeNoisyElement

			window.customElements.define("three-box", ThreeBoxElement);
			window.customElements.define("three-noisy", ThreeNoisyElement);
		</script>

		<!-- basic demo styles -->
		<style>
			* {
				box-sizing: border-box;;
			}
			html, body {
				height: 100%;
				width: 100%;
			}
			body {
				margin: 0;
			}
		</style>
	</head>
	<body>
		<!-- define a three.js scene using three-elements -->
		<three-world>
			<!-- camera -->
			<three-noisy
				position="0 1.5 0"
				rotation="-20 0 0"
				camera
				message="cameracameramcaeramcaemramcamer"
			></three-noisy>

			<!-- basic "hello world" scene -->
			<three-entity
				position="1 0 -3"
				geometry="primitive: box"
				material="color: red"
				mesh
				noisy="message: redredredredred"
			></three-entity>
			<three-entity
				position="0 0.5 -5"
				geometry="
					primitive: sphere;
					radius: 1;
				"
				material="
					type: custom;
					shader: Shader;
				"
				mesh
			></three-entity>
			<three-box
				position="-1 0 -3"
				material-type="custom"
				shader="Shader"
			></three-box>
		</three-world>
	</body>
</html>
